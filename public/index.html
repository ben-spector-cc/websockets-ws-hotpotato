<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/public/styles.css">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon" />
  <script src="/utils/constants.js"></script>
  <title>Hot Potato</title>
</head>
<body>
  <div id="game-text">
      <h1 id="display">Waiting for game to start...</h1>
  </div>
  <div id="game">
      <div id="table">   
    <div class="player" id="BLUE"><img class="playerAvatar" src="https://static-assets.codecademy.com/Courses/Learn-WebSocket/BLUE_COLD.png"></div>
    <div class="player" id="GREEN"><img class="playerAvatar" src="https://static-assets.codecademy.com/Courses/Learn-WebSocket/GREEN_COLD.png"></div>
    <div class="player" id="PINK"><img class="playerAvatar" src="https://static-assets.codecademy.com/Courses/Learn-WebSocket/PINK_COLD.png"></div>
    <div class="player" id="YELLOW"><img class="playerAvatar" src="https://static-assets.codecademy.com/Courses/Learn-WebSocket/YELLOW_COLD.png"></div>
  </div>
  </div>


  <script>
    ////////////////////////////////////////////////
    ////////////// VARIABLES ///////////////////////
    ////////////////////////////////////////////////
    
    // DOM Elements
    const display = document.getElementById('display');
    
    // Application Variables
    let wsClient = null;            // The client-side WebSocket connection variable: new WebSocket() 
    let clientPlayerIndex = null;   // The index value of the client: 0 | 1 | 2 | 3
    let potatoHolderIndex = null;   // The index value of the current holder of the potato: 0 | 1 | 2 | 3
    let gameIsRunning = false;      // True when there are 4 or more people, false otherwise.
    
    ////////////////////////////////////////////////
    //////////// DOM SETUP /////////////////////////
    ////////////////////////////////////////////////

    function updateDisplay(value, backgroundColor) {
      display.innerHTML = value;
      if (backgroundColor) {
        display.style.background = backgroundColor;
      }
    }

    // Render the four players
    const playerColors = ['BLUE', 'GREEN', 'PINK', 'YELLOW'];
    const playerElements = [...document.getElementsByClassName('player')];

    // make each other player clickable
    playerElements.forEach((playerElement, i) => {
      playerElement.onclick = function() {
        // Only allow clicks if the game is running, the client is holding the potato, and they didn't click on themselves
        if (gameIsRunning && clientPlayerIndex === potatoHolderIndex && clientPlayerIndex === i ) {  
          // and pass the potato
          passThePotatoTo(i);
        }
      } 
    });  

    // Sets the current potatoHolderIndex ands sends it to the server
    function passThePotatoTo(playerIndex) { 
      // set the potatoHolderIndex to be the player that was clicked on
      potatoHolderIndex = playerIndex;
      
      // TODO: tell the server who the client clicked on
      wsClient.send(JSON.stringify({
        type: CLIENT.MESSAGE.PASS_POTATO,
        payload: { newPotatoHolderIndex: playerIndex }
      }));
    }

    ////////////////////////////////////////////////
    ///////////////// WS LOGIC /////////////////////
    ////////////////////////////////////////////////

    function init() {
      // if a WebSocket connection exists already, close it
      if (wsClient) {
        wsClient.onerror = wsClient.onopen = wsClient.onclose = null;
        wsClient.close();
      }

      // TODO: create a new WebSocket connection with the server using the wss protocol
      const URL = 'wss://localhost:' + PORT;
      wsClient = new WebSocket(URL);

      // TODO: .onopen() is executed when a connection is made (when the handshake completes)
      wsClient.onopen = () => {
        const data = {
          type: CLIENT.MESSAGE.NEW_USER
        };
        wsClient.send(JSON.stringify(data));
      }

      // TODO: .onmessage() is executed when the server sends data to a WebSocket client
      wsClient.onmessage = (messageEvent) => {
        // TODO: Parse the event.data
        const { data } = messageEvent;
        const { type, payload } = JSON.parse(data);

        // TODO: Switch on the type and call the correct function, passing along the payload data
        switch (type) {
          case SERVER.MESSAGE.PLAYER_ASSIGNMENT:
            // update the client's clientPlayerIndex
            setPlayerIndex(payload.clientPlayerIndex);
            break;
          case SERVER.BROADCAST.GAME_START:
            startGame();
            break;
          case SERVER.BROADCAST.COUNTDOWN:
            countDown(payload.clockValue);
            break;
          case SERVER.BROADCAST.NEW_POTATO_HOLDER:
            updateCurrentPotatoHolder(payload.newPotatoHolderIndex);
            break;
          case SERVER.BROADCAST.GAME_OVER:
            endGame();
            break;
          case SERVER.MESSAGE.GAME_FULL:
            updateDisplay('Game Full');
            break;
          default:
            break;
        }
      };

      // .onclose is executed when the socket connection is closed
      wsClient.onclose = function() {
        updateDisplay('No WebSocket connection');
        wsClient = null;
      }

      // .onerror is executed when error event occurs on the WebSocket connection
      wsClient.onerror = function(e) {
        console.error("WebSocket error observed:", e);
        wsClient = null;
      }
    }
    
    // Start the WebSocket server
    init();

    ////////////////////////////////////////////////
    //////////// HELPER FUNCTIONS //////////////////
    ////////////////////////////////////////////////

    // Render the current time with a different color based on the time value
    function countDown(time) {
      let color = '#63fe34a1';
      if (time <= 5) {
        color = '#ff0000b5';
      } else if (time <= 15) {
        color = '#ff7800c7';
      } else if (time <= 25) {
        color = '#ffee00b5';
      }
      updateDisplay(time, color);
    }

    // Assigns the client's player index and appends a star to their avatar indicating which player they are.
    function setPlayerIndex(playerIndex) {
      clientPlayerIndex = playerIndex;

      // create the star and append the image to the proper player based on the playerIndex
      const img = document.createElement('img');
      img.src = `https://static-assets.codecademy.com/Courses/Learn-WebSocket/you_star.png`;
      img.className = 'star';
      playerElements[playerIndex].appendChild(img);
    }
    
    // Updates the potatoHolderIndex value and sets each playerAvatar image to either be "HOT" or "COLD" accordingly
    function updateCurrentPotatoHolder(newPotatoHolderIndex) {
      // remove the hasPotato class from any existing elements that have it
      potatoHolderIndex = newPotatoHolderIndex;
      playerElements.forEach((playerElement, i) => {
        const playerAvatar = playerElement.childNodes[0];
        playerAvatar.src = i === potatoHolderIndex ? playerAvatar.src.replace('COLD', 'HOT') : playerAvatar.src.replace('HOT', 'COLD');
      })
    }

    function startGame() {
      gameIsRunning = true;
    }

    function endGame() {
      gameIsRunning = false;
      if (potatoHolderIndex === clientPlayerIndex) {
        updateDisplay('You Lose', '#ff0000b5');
      } else {
        updateDisplay('You Win!', '#63fe34a1');
      }
    }

  </script>
</body>
</html>